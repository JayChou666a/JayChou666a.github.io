<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B站视频热度评估工具</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* 样式保持不变 */
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>B站视频热度评估工具</h1>
            <p class="subtitle">输入视频信息，评估热度及进入每周必看的概率</p>
        </header>
        
        <div class="content">
            <div class="input-section">
                <h2>视频基本信息</h2>
                <div class="form-group">
                    <label for="up-name">UP主名称</label>
                    <input type="text" id="up-name" placeholder="请输入UP主名称">
                </div>
                
                <div class="form-group">
                    <label for="video-type">视频子分区</label>
                    <input type="text" id="video-type" placeholder="请输入视频子分区，如: 数码">
                </div>
                
                <div class="form-group">
                    <label for="tags">视频标签（用逗号分隔）</label>
                    <input type="text" id="tags" placeholder="例如: 科技,测评,手机">
                </div>
                
                <h2>视频数据信息</h2>
                <div class="form-group">
                    <label for="views">观看数</label>
                    <input type="number" id="views" placeholder="请输入观看数">
                </div>
                
                <div class="form-group">
                    <label for="danmu">弹幕数</label>
                    <input type="number" id="danmu" placeholder="请输入弹幕数">
                </div>
                
                <div class="form-group">
                    <label for="comments">评论数</label>
                    <input type="number" id="comments" placeholder="请输入评论数">
                </div>
                
                <div class="form-group">
                    <label for="likes">点赞数</label>
                    <input type="number" id="likes" placeholder="请输入点赞数">
                </div>
                
                <div class="form-group">
                    <label for="favorites">收藏数</label>
                    <input type="number" id="favorites" placeholder="请输入收藏数">
                </div>
                
                <div class="form-group">
                    <label for="coins">投币数</label>
                    <input type="number" id="coins" placeholder="请输入投币数">
                </div>
                
                <div class="form-group">
                    <label for="shares">分享数</label>
                    <input type="number" id="shares" placeholder="请输入分享数">
                </div>
                
                <h2>其他信息</h2>
                <div class="form-group">
                    <label for="duration">视频时长（秒）</label>
                    <input type="number" id="duration" placeholder="请输入视频时长（秒）">
                </div>
                
                <button id="evaluate-btn" class="btn">评估视频热度</button>
            </div>
            
            <div class="result-section">
                <h2>评估结果</h2>
                <div id="initial-message" class="result-card">
                    <p>请填写左侧表单并点击"评估视频热度"按钮，将在此处显示评估结果。</p>
                </div>
                
                <div id="loading" class="result-card hidden">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>正在评估视频数据，请稍候...</p>
                    </div>
                </div>
                
                <div id="result-container" class="hidden">
                    <div class="result-card">
                        <h3 class="result-title">详细评分</h3>
                        <div class="score-item">
                            <span class="score-label">UP主影响力评分</span>
                            <span class="score-value" id="up-score">-</span>
                        </div>
                        <div class="score-item">
                            <span class="score-label">视频类型评分</span>
                            <span class="score-value" id="type-score">-</span>
                        </div>
                        <div class="score-item">
                            <span class="score-label">标签匹配度评分</span>
                            <span class="score-value" id="tag-score">-</span>
                        </div>
                        <div class="score-item">
                            <span class="score-label">观看数评分</span>
                            <span class="score-value" id="views-score">-</span>
                        </div>
                        <div class="score-item">
                            <span class="score-label">弹幕数评分</span>
                            <span class="score-value" id="danmu-score">-</span>
                        </div>
                        <div class="score-item">
                            <span class="score-label">评论数评分</span>
                            <span class="score-value" id="comments-score">-</span>
                        </div>
                        <div class="score-item">
                            <span class="score-label">点赞数评分</span>
                            <span class="score-value" id="likes-score">-</span>
                        </div>
                        <div class="score-item">
                            <span class="score-label">收藏数评分</span>
                            <span class="score-value" id="favorites-score">-</span>
                        </div>
                        <div class="score-item">
                            <span class="score-label">投币数评分</span>
                            <span class="score-value" id="coins-score">-</span>
                        </div>
                        <div class="score-item">
                            <span class="score-label">分享数评分</span>
                            <span class="score-value" id="shares-score">-</span>
                        </div>
                        <div class="score-item">
                            <span class="score-label">视频时长评分</span>
                            <span class="score-value" id="duration-score">-</span>
                        </div>
                    </div>
                    
                    <div class="result-card">
                        <h3 class="result-title">综合评分</h3>
                        <div class="final-score" id="total-score">-</div>
                        <div class="probability">
                            进入每周必看的概率: <span id="probability">-</span>%
                        </div>
                        <div class="conclusion hidden" id="conclusion"></div>
                    </div>
                    
                    <div class="result-card">
                        <h3 class="result-title">与每周必看视频对比</h3>
                        <table class="stats-table">
                            <thead>
                                <tr>
                                    <th>指标</th>
                                    <th>您的视频</th>
                                    <th>必看平均值</th>
                                    <th>必看3/5指标</th>
                                    <th>比较结果</th>
                                </tr>
                            </thead>
                            <tbody id="stats-comparison">
                                <!-- 动态填充对比数据 -->
                            </tbody>
                        </table>
                        <div style="margin-top: 15px;">
                            <strong>您的视频时长:</strong> <span id="duration-user">-</span>秒
                            <strong>视频时长平均值:</strong> <span id="duration-avg">-</span>秒
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const evaluateBtn = document.getElementById('evaluate-btn');
            const initialMessage = document.getElementById('initial-message');
            const loadingElement = document.getElementById('loading');
            const resultContainer = document.getElementById('result-container');
            const conclusionElement = document.getElementById('conclusion');
            
            // 评估函数
            async function evaluateVideo(data) {
                loadingElement.classList.remove('hidden');
                initialMessage.classList.add('hidden');
                resultContainer.classList.add('hidden');
                
                try {
                    // 构造符合API要求的请求体
                    const requestBody = {
                        up_name: data.up_name,
                        video_type: data.video_type,
                        video_tag: data.video_tag,
                        views: data.views,
                        danmu: data.danmu,
                        comments: data.comments,
                        likes: data.likes,
                        favorites: data.favorites,
                        coins: data.coins,
                        shares: data.shares,
                        duration: data.duration
                    };

                    const response = await fetch('http://localhost:5000/api/evaluate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(requestBody)
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    displayResults(result.result);
                    
                } catch (error) {
                    console.error('评估失败:', error);
                    alert(`评估失败: ${error.message}`);
                } finally {
                    loadingElement.classList.add('hidden');
                }
            }
            
            // 显示结果
            function displayResults(result) {
                // 更新各项评分
                document.getElementById('up-score').textContent = result.score_details.up_name.toFixed(1);
                document.getElementById('type-score').textContent = result.score_details.video_type.toFixed(1);
                document.getElementById('tag-score').textContent = result.score_details.video_tag.toFixed(1);
                document.getElementById('views-score').textContent = result.score_details.views.toFixed(1);
                document.getElementById('danmu-score').textContent = result.score_details.danmu.toFixed(1);
                document.getElementById('comments-score').textContent = result.score_details.comments.toFixed(1);
                document.getElementById('likes-score').textContent = result.score_details.likes.toFixed(1);
                document.getElementById('favorites-score').textContent = result.score_details.favorites.toFixed(1);
                document.getElementById('coins-score').textContent = result.score_details.coins.toFixed(1);
                document.getElementById('shares-score').textContent = result.score_details.shares.toFixed(1);
                document.getElementById('duration-score').textContent = result.score_details.duration.toFixed(1);
                
                // 更新总分和概率
                document.getElementById('total-score').textContent = result.popularity_score.toFixed(1);
                document.getElementById('probability').textContent = (result.probability * 100).toFixed(1);
                
                // 更新结论
                conclusionElement.textContent = result.prediction;
                conclusionElement.className = 'conclusion ' + 
                    (result.prediction === 'Weekly Featured' ? 'success' : 'failure');
                conclusionElement.classList.remove('hidden');
                
                // 更新对比表格
                updateComparisonTable(result);
                
                // 更新时长显示
                document.getElementById('duration-avg').textContent = result.featured_stats.duration_avg;
                document.getElementById('duration-user').textContent = result.raw_values.duration;
                
                // 显示结果容器
                resultContainer.classList.remove('hidden');
            }
            
            // 更新对比表格
            function updateComparisonTable(result) {
                const comparisonTable = document.getElementById('stats-comparison');
                comparisonTable.innerHTML = '';
                
                const metrics = [
                    { key: 'views', label: '观看数' },
                    { key: 'likes', label: '点赞数' },
                    { key: 'coins', label: '投币数' },
                    { key: 'favorites', label: '收藏数' },
                    { key: 'shares', label: '分享数' },
                    { key: 'danmu', label: '弹幕数' },
                    { key: 'comments', label: '评论数' }
                ];
                
                metrics.forEach(metric => {
                    const row = document.createElement('tr');
                    
                    // 使用后端返回的原始值
                    const userValue = result.raw_values[metric.key];
                    const avgValue = result.featured_stats.averages[metric.key];
                    const threeFifthValue = result.featured_stats.three_fifths[metric.key];
                    
                    // 比较结果
                    let comparisonClass = 'comparison-equal';
                    let comparisonText = '≈';
                    
                    if (userValue > avgValue * 1.1) {
                        comparisonClass = 'comparison-better';
                        comparisonText = '>';
                    } else if (userValue < avgValue * 0.9) {
                        comparisonClass = 'comparison-worse';
                        comparisonText = '<';
                    }
                    
                    row.innerHTML = `
                        <td>${metric.label}</td>
                        <td>${userValue.toLocaleString()}</td>
                        <td>${avgValue.toLocaleString()}</td>
                        <td>${threeFifthValue.toLocaleString()}</td>
                        <td class="${comparisonClass}">${comparisonText}</td>
                    `;
                    
                    comparisonTable.appendChild(row);
                });
            }
            
            // 点击评估按钮
            evaluateBtn.addEventListener('click', function() {
                // 确保使用正确的字段名
                const requestData = {
                    up_name: document.getElementById('up-name').value.trim(),
                    video_type: document.getElementById('video-type').value.trim(),
                    video_tag: document.getElementById('tags').value.trim() || '',
                    views: Number(document.getElementById('views').value) || 0,
                    danmu: Number(document.getElementById('danmu').value) || 0,
                    comments: Number(document.getElementById('comments').value) || 0,
                    likes: Number(document.getElementById('likes').value) || 0,
                    favorites: Number(document.getElementById('favorites').value) || 0,
                    coins: Number(document.getElementById('coins').value) || 0,
                    shares: Number(document.getElementById('shares').value) || 0,
                    duration: Number(document.getElementById('duration').value) || 0
                };

                // 验证必填字段
                if (!requestData.up_name || !requestData.video_type || isNaN(requestData.views)) {
                    alert('请填写UP主名称、视频分区和观看数');
                    return;
                }

                evaluateVideo(requestData);
            });
        });
    </script>
</body>
</html>
